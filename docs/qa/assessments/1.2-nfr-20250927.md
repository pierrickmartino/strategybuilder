# NFR Assessment – Story 1.2 (Core Canvas Blocks & Validation)

- **Date**: 2025-09-27
- **Assessed NFRs**: security, performance, reliability, maintainability, usability, compatibility, portability, functional suitability
- **Quality Score**: 70 (CONCERNS)

## Key Takeaways
- Authenticated routing and shared validator logic satisfy the documented security controls for strategy version workflows.
- Autosave persistence and local storage history raise performance headroom concerns for large graphs or long editing sessions.
- Duplicated graph-cloning helpers and browser-only APIs introduce maintainability and compatibility risks that should be addressed post-story.

## Security — PASS
- `require_compliance_consent` gating and workspace scoping on every version operation (`apps/api/app/api/routers/strategy_versions.py:40`, `apps/api/app/services/strategy_version_service.py:24`) keep edits scoped to the owner.
- Shared validator enforces required inputs, quota limits, and parameter bounds before persisting (`apps/api/app/services/graph_validation_service.py:55`).
- Tests exercise validation and quota enforcement paths (`apps/api/tests/test_strategy_versions.py:118`).

## Performance — CONCERNS
- Persisted store retains full graphs plus 50-change undo stacks for every version in localStorage (`apps/web/src/stores/useStrategyCanvas.ts:14`, `apps/web/src/stores/useStrategyCanvas.ts:102`), risking 5 MB quota pressure and serialization cost on each mutation.
- Autosave still creates full versions on a 1.5 s debounce even during rapid drag sessions (`apps/web/src/components/canvas/StrategyCanvas.tsx:310`), which can flood the API without rate feedback.

**Recommendation**: Trim persisted history (e.g., partialize stored state or move undo stacks in-memory) and introduce adaptive autosave throttling or batching before high-volume rollouts.

## Reliability — PASS
- Service layer validates ownership and gracefully errors when reverting unknown versions (`apps/api/app/services/strategy_version_service.py:103`).
- Canvas store snapshots and undo/redo operations are capped and exercised by integration tests (`apps/web/tests/integration/StrategyCanvas.test.tsx:17`).

## Maintainability — CONCERNS
- Graph cloning logic is duplicated between the store and the component (`apps/web/src/stores/useStrategyCanvas.ts:16`, `apps/web/src/components/canvas/StrategyCanvas.tsx:54`), inviting divergence during future schema tweaks.
- Persisted state lacks a storage version/migration path; schema changes to `StrategyGraph` would strand stale local snapshots.

**Recommendation**: Extract a shared `cloneStrategyGraph` utility and add `persist` versioning/migrations to defend against future contract changes.

## Usability — PASS
- Inspector inputs wire `label`/`htmlFor` pairs and provide hint copy for constrained parameters (`apps/web/src/components/canvas/CanvasInspector.tsx:53`).
- Validation status messaging surfaces pending, success, and error states inline for quick recovery (`apps/web/src/components/canvas/StrategyCanvas.tsx:295`).

## Compatibility — CONCERNS
- New node IDs rely on `crypto.randomUUID()` (`apps/web/src/components/canvas/StrategyCanvas.tsx:270`), which breaks on older Safari/WebView stacks we still field in customer feedback.

**Recommendation**: Polyfill via `crypto.randomUUID ?? nanoid()` or ship a small UUID helper compatible back to Safari 13.

## Portability — PASS
- Block definitions remain loaded from the shared package with `lru_cache`, keeping backend/frontend contracts aligned (`apps/api/app/data/block_definitions.py:55`).
- API service returns plain dictionaries suitable for Supabase-hosted Postgres without engine-specific types.

## Functional Suitability — PASS
- Integration and E2E suites cover validation reporting, version history loading, and revert flows (`apps/web/tests/integration/StrategyCanvas.test.tsx:43`, `tests/e2e/canvas-designer.spec.ts:5`).
- Backend unit tests assert quota enforcement and history persistence behaviour (`apps/api/tests/test_strategy_versions.py:94`).

