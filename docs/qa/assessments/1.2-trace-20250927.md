# Requirements Traceability Matrix

## Story: 1.2 - Core Canvas Blocks & Validation

### Coverage Summary
- Total Requirements: 4
- Fully Covered: 0 (0%)
- Partially Covered: 4 (100%)
- Not Covered: 0 (0%)

### Requirement Mappings

#### AC1: Canvas supports drag-and-drop, block linking, and deletion with undo, using at least five starter block types
**Coverage: PARTIAL**
- test_file: `apps/web/tests/unit/stores/useStrategyCanvas.test.ts`
  test_case: "adds nodes and edges with undo/redo support"
  given: Canvas store seeded with a market node and empty edges
  when: Upserting a momentum node, linking the nodes, and calling undo/redo
  then: Store reflects new node, link, and undo stack transitions correctly
  coverage: unit
- test_file: `tests/e2e/canvas-designer.spec.ts`
  test_case: "supports block drag/drop, inline validation, and version rollback"
  given: User loads the strategy designer page with starter palette
  when: Dragging a Momentum Indicator block onto the canvas
  then: Block appears on the surface and flow continues without runtime errors
  coverage: e2e

#### AC2: Inline validation flags missing inputs, incompatible block connections, and quota breaches
**Coverage: PARTIAL**
- test_file: `apps/api/tests/test_strategy_versions.py`
  test_case: "test_validate_detects_missing_input"
  given: Graph omits a required inbound signal for the entry node
  when: Running `validate_version_graph`
  then: Validation issues include a `missing_input` error targeting the node
  coverage: unit
- test_file: `apps/api/tests/test_strategy_versions.py`
  test_case: "test_quota_issue_emitted_for_free_plan"
  given: Free-plan user with graph exceeding allowed broker nodes
  when: Running `validate_version_graph`
  then: Validation response contains a `quota_exceeded` issue
  coverage: unit
- test_file: `apps/web/tests/unit/stores/useStrategyCanvas.test.ts`
  test_case: "tracks validation states"
  given: Canvas store initialised with version metadata
  when: Marking validation pending, setting results, and handling errors
  then: Zustand state transitions through pending, idle, and error as expected
  coverage: unit
- test_file: `apps/web/tests/unit/components/CanvasNode.test.tsx`
  test_case: "shows error badge when issues contain errors"
  given: Canvas node rendered with an error-level issue
  when: Rendering the component
  then: Error badge and message render to alert the user
  coverage: unit
- test_file: `apps/web/tests/unit/components/CanvasNode.test.tsx`
  test_case: "shows warning badge when only warnings are present"
  given: Canvas node rendered with a warning-level issue
  when: Rendering the component
  then: Warning badge surfaces the caution state without error styling
  coverage: unit
- test_file: `apps/web/tests/integration/StrategyCanvas.test.tsx`
  test_case: "runs validation and surfaces result summary"
  given: Canvas rendered with mocks for validation hook
  when: Clicking the Validate button
  then: Hook invoked and inline summary displays detected issues
  coverage: integration
- test_file: `tests/e2e/canvas-designer.spec.ts`
  test_case: "supports block drag/drop, inline validation, and version rollback"
  given: User on the designer page with invalid graph state
  when: Triggering validation from the toolbar
  then: Inline "issues detected" message becomes visible in the UI
  coverage: e2e

#### AC3: Block configuration side panel exposes editable parameters with hint text and default ranges
**Coverage: PARTIAL**
- test_file: `apps/web/tests/unit/components/CanvasInspector.test.tsx`
  test_case: "renders parameter controls and dispatches updates"
  given: Inspector provided with a momentum node definition
  when: Editing the fast window parameter via numeric input
  then: Update handler receives the new numeric value
  coverage: unit
- test_file: `apps/web/tests/unit/components/CanvasInspector.test.tsx`
  test_case: "shows placeholder when no node selected"
  given: Inspector receives a null node
  when: Rendering the component
  then: Placeholder guidance prompts the user to pick a block
  coverage: unit
- test_file: `apps/web/tests/unit/stores/useStrategyCanvas.test.ts`
  test_case: "persists parameter updates"
  given: Canvas store seeded with starter graph
  when: Updating node metadata parameters via `updateGraph`
  then: Zustand state reflects the persisted parameter changes
  coverage: unit

#### AC4: Strategy versions auto-save with timestamped history and ability to revert to previous version
**Coverage: PARTIAL**
- test_file: `apps/api/tests/test_strategy_versions.py`
  test_case: "test_create_version_persists_history"
  given: Workspace seeded with demo strategy and VALID_GRAPH payload
  when: Calling `create_version` and listing versions
  then: Version number increments, validation issues empty, and history ordered by recency
  coverage: integration
- test_file: `apps/api/tests/test_strategy_versions.py`
  test_case: "test_revert_clones_target_version"
  given: Strategy with seed and latest versions recorded in the database
  when: Invoking `revert_to_version`
  then: New version clones target graph and notes revert provenance
  coverage: integration
- test_file: `tests/e2e/canvas-designer.spec.ts`
  test_case: "supports block drag/drop, inline validation, and version rollback"
  given: User with existing history entries
  when: Selecting a previous version via Revert action
  then: UI displays confirmation that the version was restored
  coverage: e2e
- test_file: `apps/web/tests/integration/StrategyCanvas.test.tsx`
  test_case: "invokes callbacks when loading versions"
  given: Canvas rendered with mocked version hooks
  when: Executing the Load action from version history
  then: Callback fires allowing caller to hydrate reverted graph
  coverage: integration

### Critical Gaps
1. Deletion flows, five-starter-block catalog enforcement, and undo coverage for removals are untested (AC1).
2. No automated coverage for incompatible connection violations or UI mapping of quota errors beyond happy path (AC2).
3. Inspector hint text, range enforcement, and React Query persistence path lack tests (AC3).
4. Autosave scheduler, failure recovery UX, and timestamp auditing remain unvalidated (AC4).

### Test Design Recommendations
1. Add unit and integration tests exercising delete/undo reducers and verifying starter block catalog completeness.
2. Extend validation suites to cover incompatible connections and ensure UI surfaces quota/incompatible errors distinctly.
3. Write component/integration tests asserting parameter hint text, min/max enforcement, and server sync via React Query.
4. Implement autosave hook tests (debounce, failure) plus API tests for optimistic locking and timestamp accuracy.

### Risk Assessment
- High Risk: AC4 gaps around autosave failure handling could cause data loss regressions.
- Medium Risk: AC1 deletion coverage and AC2 incompatible connection gaps may allow invalid graphs into production.
- Low Risk: AC3 hint text gaps primarily affect UX polish but should be addressed for accessibility.

Trace matrix: docs/qa/assessments/1.2-trace-20250927.md
