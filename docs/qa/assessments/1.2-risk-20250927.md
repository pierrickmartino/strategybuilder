# Risk Profile: Story 1.2 – Core Canvas Blocks & Validation (2025-09-27)

- **Story ID:** 1.2
- **Title:** Core Canvas Blocks & Validation
- **Reviewer:** Quinn (Test Architect & Quality Advisor)
- **Context:** Drag-and-drop strategy canvas with shared block contracts, real-time validation, configuration side panel, and autosave/version history.
- **Overall Gate Recommendation:** CONCERNS (high-risk items present)
- **Base Risk Score:** 71 (High risk ×2, Medium risk ×1, Low risk ×2)

## Risk Matrix
| Risk ID  | Description | Probability | Impact | Score | Priority |
|----------|-------------|-------------|--------|-------|----------|
| TECH-002 | Canvas state orchestration across drag/drop, linking, undo, and persistence layers | Medium (2) | High (3) | 6 | High |
| DATA-002 | Autosave/version snapshots can overwrite or lose block graphs under race conditions | Medium (2) | High (3) | 6 | High |
| PERF-002 | Real-time validation round-trips throttle UX when graph changes trigger backend load | Medium (2) | Medium (2) | 4 | Medium |
| SEC-003  | Validation gaps allow malformed or quota-violating graphs to persist server-side | Low (1) | High (3) | 3 | Low |
| OPS-002  | Undo/redo plus autosave floods history, obscuring meaningful revert points | Medium (2) | Low (1) | 2 | Low |

## Detailed Risk Register

### TECH-002 – Canvas state orchestration across drag/drop, linking, undo, and persistence layers
- **Category:** Technical
- **Description:** Canvas behavior spans React components, Zustand store, shared contracts, and FastAPI persistence. Divergent updates (e.g., undo mutations not reflected in persisted graphs) can desynchronize UI and backend state.
- **Affected Components:** `apps/web/src/components/canvas/**`, `apps/web/src/stores/useStrategyCanvas.ts`, `packages/shared/blocks`, FastAPI strategy routes.
- **Probability:** Medium (2) — multiple surfaces changing simultaneously, with high interaction complexity.
- **Impact:** High (3) — inconsistent state breaks AC1 undo guarantees and can corrupt user strategies.
- **Score:** 6 (High)
- **Mitigation:** Establish authoritative block graph contract in `packages/shared`, add integration tests covering drag/link/delete/undo flows, require e2e regression for undo stack, and gate merges on passing contract tests.
- **Residual Risk:** Medium until cross-surface contract tests and UX validation land.
- **Detection / Monitoring:** Add frontend runtime checks for store/persisted graph divergence, monitor API error rates for invalid undo payloads.

### DATA-002 – Autosave/version snapshots can overwrite or lose block graphs under race conditions
- **Category:** Data
- **Description:** Autosave triggers on “significant graph updates.” Without debouncing and optimistic locking, concurrent edits or rapid changes can overwrite the latest graph or persist partially applied updates.
- **Affected Components:** React autosave hooks, FastAPI `/strategies/{id}/versions`, Supabase transaction layer, `StrategyVersion` schema.
- **Probability:** Medium (2) — simultaneous edits or quick successive drags are expected.
- **Impact:** High (3) — users lose work, violating AC4 revert expectations and damaging trust.
- **Score:** 6 (High)
- **Mitigation:** Use debounced save queue with last-write-wins tracking, implement server-side version tokens to reject stale updates, add integration tests simulating concurrent saves, and provide user feedback when autosave fails.
- **Residual Risk:** Medium; mitigations rely on disciplined concurrency handling.
- **Detection / Monitoring:** Track version create failures, log optimistic locking rejections, alert on save latency spikes.

### PERF-002 – Real-time validation round-trips throttle UX when graph changes trigger backend load
- **Category:** Performance
- **Description:** Each graph mutation can trigger FastAPI validation. Without batching or local prechecks, the UI may stutter and the backend may experience CPU spikes or queue buildup.
- **Affected Components:** Zustand listeners, validation event emitters, FastAPI validation pipeline, Supabase quotas.
- **Probability:** Medium (2) — heavy canvas interactions common during editing sessions.
- **Impact:** Medium (2) — degraded responsiveness harms usability but is recoverable.
- **Score:** 4 (Medium)
- **Mitigation:** Batch validation requests, cache recent validation responses, add rate limiting per session, instrument latency metrics, and include load tests focused on validation throughput.
- **Residual Risk:** Medium unless performance tests become part of CI.
- **Detection / Monitoring:** Monitor validation endpoint latency, front-end paint timings, and user feedback telemetry on canvas responsiveness.

### SEC-003 – Validation gaps allow malformed or quota-violating graphs to persist server-side
- **Category:** Security
- **Description:** If backend validation fails to enforce quotas or input sanitization (e.g., missing dependency checks), malicious or buggy clients can persist invalid graphs, potentially triggering downstream execution issues or quota abuse.
- **Affected Components:** FastAPI validation pipeline, shared error interpretation helpers, Supabase storage constraints.
- **Probability:** Low (1) — architecture mandates validation, but implementation complexity leaves room for misses.
- **Impact:** High (3) — invalid graphs could crash execution engines or enable quota bypass.
- **Score:** 3 (Low)
- **Mitigation:** Enforce server-side schema validation, add negative test cases for quota breaches, integrate static analysis for validation rules, and ensure shared helpers reject unexpected shapes.
- **Residual Risk:** Low with comprehensive negative testing, but periodic audits required.
- **Detection / Monitoring:** Alert on validation error spikes, log quota-related saves, run scheduled audits to detect malformed graphs.

### OPS-002 – Undo/redo plus autosave floods history, obscuring meaningful revert points
- **Category:** Operational
- **Description:** Aggressive autosave combined with granular history entries can produce noisy version logs, making it hard to identify useful restore points and bloating storage costs.
- **Affected Components:** Autosave scheduler, version history UI, database storage policies.
- **Probability:** Medium (2) — users typically tweak blocks repeatedly.
- **Impact:** Low (1) — operational burden and UX noise, but not catastrophic.
- **Score:** 2 (Low)
- **Mitigation:** Implement snapshot throttling, allow manual bookmark of important versions, expire low-value versions, and provide filters in the UI to highlight key saves.
- **Residual Risk:** Low when throttling and UI affordances ship.
- **Detection / Monitoring:** Track versions-per-session metrics, alert on unusual volume per strategy, review storage growth trends.

## Risk-Based Testing Strategy
- **Priority 1 (High Risks – must execute pre-ship):**
  - Integration tests for drag/link/delete/undo flows verifying persisted graph parity and undo reliability.
  - Concurrency-focused API tests simulating overlapping autosave writes with version tokens.
- **Priority 2 (Medium Risks):**
  - Performance/load tests for validation endpoint under bursty canvas edits.
  - Frontend throttling tests ensuring validation batching keeps UI responsive.
- **Priority 3 (Low Risks):**
  - Security negative tests covering malformed graph payloads and quota breaches.
  - Operational regression tests validating version history pruning and UI filtering.

## Development Focus Recommendations
- Centralize block schema contract and enforce it via shared TypeScript/Pydantic definitions.
- Implement autosave queue management with optimistic locking and explicit user feedback on save status.
- Build validation batching with circuit breakers to protect API throughput and surface degraded mode messaging.

## Deployment & Rollout Guidance
- Use feature flag or gradual rollout for autosave + validation to monitor real user impact before full exposure.
- Provide rollback path disabling autosave or reverting to manual save if concurrency defects appear.
- Coordinate deployment across frontend and backend to ensure block contracts remain compatible.

## Monitoring Requirements
- Metrics: validation latency, autosave success/failure counts, versions created per session, undo stack depth usage.
- Alerts: sustained validation latency > SLA, spike in autosave failures, storage growth anomalies from version history.
- Dashboards: canvas interaction health (drag success rate, validation error distribution) and autosave throughput.

## Risk Acceptance
- Critical risks (score ≥ 9): none identified.
- High risks (score 6): TECH-002 and DATA-002 require mitigations before production sign-off or explicit leadership waiver.
- Medium/Low risks acceptable with noted monitoring and follow-up actions.

---
Risk profile: docs/qa/assessments/1.2-risk-20250927.md
