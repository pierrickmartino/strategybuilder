# Test Design: Story 1.1 – Platform Skeleton & Authentication

Date: 2025-09-27
Designer: Quinn (Test Architect & Quality Advisor)

## Test Strategy Overview

- Total test scenarios: 11
- Unit tests: 2 (18%)
- Integration tests: 5 (45%)
- E2E tests: 4 (36%)
- Priority distribution: P0: 6, P1: 5, P2: 0, P3: 0

## Test Scenarios by Acceptance Criteria

### AC1: Monorepo scaffold with Turbo repo, workspace config, and CI lint/test pipeline

| ID             | Level       | Priority | Test | Justification |
|----------------|-------------|----------|------|---------------|
| 1.1-INT-001    | Integration | P1       | Execute `pnpm turbo run lint` and `pnpm turbo run test --dry-run` to ensure workspace definitions and pipeline wiring remain valid after changes. | Validates cross-package Turborepo orchestration without requiring full E2E setup. |

### AC2: Supabase authentication with consent enforcement across email/OAuth flows

| ID             | Level       | Priority | Test | Justification |
|----------------|-------------|----------|------|---------------|
| 1.1-UNIT-001   | Unit        | P0       | Validate consent form logic enforces `simulationConsent` for both email/password and OAuth paths. | Pure UI/business logic; fast regression coverage for SEC-001. |
| 1.1-UNIT-002   | Unit        | P0       | Assert Supabase cookie helper sets `HttpOnly`, `Secure`, `SameSite=strict`, and rotation timing. | Guardrail for SEC-002 without integration overhead. |
| 1.1-INT-002    | Integration | P0       | FastAPI dependency rejects bootstrap when Supabase metadata lacks consent flag. | Ensures backend contract enforcement mitigating SEC-001. |
| 1.1-INT-003    | Integration | P0       | FastAPI dependency validates consented JWT, provisions workspace, and returns session payload consumed by Next.js. | Exercises shared auth contract across services (TECH-001) while staying below E2E cost. |
| 1.1-E2E-001    | E2E         | P0       | Playwright: email/password signup → consent → workspace landing with sample content. | Full happy-path compliance & user journey validation. |
| 1.1-E2E-002    | E2E         | P0       | Playwright: OAuth login ensures consent modal appears, consent stored, and redirect succeeds. | High-risk SEC-001 mitigation requiring cross-system orchestration. |
| 1.1-E2E-003    | E2E         | P1       | Playwright: simulate OAuth skip consent; verify UI blocks entry, surfaces remediation, and backend returns 403. | Ensures graceful failure handling and informs user while protecting compliance. |

### AC3: Post-login workspace bootstrap with demo strategy and onboarding callouts

| ID             | Level       | Priority | Test | Justification |
|----------------|-------------|----------|------|---------------|
| 1.1-INT-004    | Integration | P1       | Workspace provisioning service handles retries idempotently (upsert Strategy + StrategyVersion). | Validates data integrity mitigation for DATA-001 without browser stack. |
| 1.1-E2E-004    | E2E         | P1       | Playwright: first-login flow renders onboarding canvas, tutorial callouts, and seeded strategy graph. | Confirms user-visible outcome and hydrates frontend stores. |

### AC4: Audit logging of auth events and workspace creation

| ID             | Level       | Priority | Test | Justification |
|----------------|-------------|----------|------|---------------|
| 1.1-INT-005    | Integration | P1       | API + logging integration test verifying Supabase auth events persist to ComplianceEvent log and emit Datadog payload. | Covers OPS-001 by validating pipeline end-to-end without external SaaS dependency. |
| 1.1-E2E-005    | E2E         | P1       | Synthetic monitoring script (scheduled) performs login and asserts audit event observed in monitoring dashboard/API. | Production-like observability guard bridging instrumentation gap for OPS-001.

## Risk Coverage

| Risk ID | Mitigated By |
|---------|--------------|
| SEC-001 | 1.1-UNIT-001, 1.1-INT-002, 1.1-INT-003, 1.1-E2E-001, 1.1-E2E-002, 1.1-E2E-003 |
| TECH-001 | 1.1-INT-003 |
| DATA-001 | 1.1-INT-004 |
| OPS-001 | 1.1-INT-005, 1.1-E2E-005 |
| SEC-002 | 1.1-UNIT-002 |

## Recommended Execution Order

1. P0 unit tests (1.1-UNIT-001, 1.1-UNIT-002)
2. P0 integration tests (1.1-INT-002, 1.1-INT-003)
3. P0 E2E journeys (1.1-E2E-001, 1.1-E2E-002)
4. Remaining P1 integration tests (1.1-INT-001, 1.1-INT-004, 1.1-INT-005)
5. P1 E2E/error handling coverage (1.1-E2E-003, 1.1-E2E-004, 1.1-E2E-005)

---

test_design:
  scenarios_total: 11
  by_level:
    unit: 2
    integration: 5
    e2e: 4
  by_priority:
    p0: 6
    p1: 5
    p2: 0
  coverage_gaps: []

Test design matrix: docs/qa/assessments/1.1-test-design-20250927.md
P0 tests identified: 6
