# Risk Profile: Story 1.1 – Platform Skeleton & Authentication (2025-09-27)

- **Story ID:** 1.1
- **Title:** Platform Skeleton & Authentication
- **Reviewer:** Quinn (Test Architect & Quality Advisor)
- **Context:** Monorepo bootstrap with Supabase authentication, consent enforcement, workspace seeding, audit logging
- **Overall Gate Recommendation:** CONCERNS (high-risk item present)
- **Base Risk Score:** 73 (High risk ×1, Medium risk ×3, Low risk ×1)

## Risk Matrix
| Risk ID  | Description | Probability | Impact | Score | Priority |
|----------|-------------|-------------|--------|-------|----------|
| SEC-001  | OAuth consent regression due to missing end-to-end coverage | Medium (2) | High (3) | 6 | High |
| TECH-001 | Fragile multi-surface auth bootstrap across Next.js ↔ FastAPI ↔ Supabase | Medium (2) | Medium (2) | 4 | Medium |
| DATA-001 | Demo workspace seeding creates inconsistent tenant data on retries | Medium (2) | Medium (2) | 4 | Medium |
| OPS-001  | Audit trail emissions not monitored for drop/misconfiguration | Medium (2) | Medium (2) | 4 | Medium |
| SEC-002  | Cookie/session hardening regressions (Secure/SameSite/rotation) | Low (1) | High (3) | 3 | Low |

## Detailed Risk Register

### SEC-001 – OAuth consent regression due to missing end-to-end coverage
- **Category:** Security
- **Description:** Consent gating for OAuth relies on new UI/metadata wiring but lacks high-level integration tests. Future refactors could bypass the consent capture, re-introducing compliance gaps.
- **Affected Components:** `apps/web/src/app/(auth)/**`, Supabase auth callbacks, FastAPI bootstrap dependency, Supabase metadata schema
- **Probability:** Medium (2) — prior regression already occurred; no automated regression guard yet
- **Impact:** High (3) — consent bypass violates compliance requirements and blocks workspace provisioning
- **Score:** 6 (High)
- **Mitigation:** Add Playwright flows covering OAuth consent, enforce consent check in FastAPI dependency before provisioning, include contract test asserting Supabase metadata flag; require code review checklist item for consent handling
- **Residual Risk:** Until automated coverage exists, manual QA must re-run OAuth flows every release
- **Detection / Monitoring:** Alert on FastAPI 403 consent errors, dashboard for Supabase metadata missing `simulation_consent` flag

### TECH-001 – Fragile multi-surface auth bootstrap across Next.js ↔ FastAPI ↔ Supabase
- **Category:** Technical
- **Description:** Auth logic spans multiple packages (middleware, API dependency, shared client). Divergence in token formats or API contracts can break the bootstrap silently.
- **Affected Components:** `apps/web/src/middleware.ts`, `packages/shared-auth`, `apps/api/src/api/dependencies/auth.py`
- **Probability:** Medium (2) — high change velocity expected while platform stabilizes
- **Impact:** Medium (2) — users blocked from onboarding; recoverable with fixes but disrupts first-use experience
- **Score:** 4 (Medium)
- **Mitigation:** Maintain shared auth contract module, add integration tests hitting FastAPI via Supabase-mocked JWT, document change process for auth dependencies
- **Residual Risk:** Medium; depends on discipline keeping shared contract authoritative
- **Detection / Monitoring:** Synthetic login probe in CI/CD, health checks on `/api/v1/bootstrap` path

### DATA-001 – Demo workspace seeding creates inconsistent tenant data on retries
- **Category:** Data
- **Description:** Re-running the bootstrap may result in duplicate `Strategy`/`StrategyVersion` records or stale demo content if idempotency is not enforced.
- **Affected Components:** Workspace seeding service, Postgres fixtures, Celery workers (if backfilled)
- **Probability:** Medium (2) — race conditions or retry flows likely during onboarding iterations
- **Impact:** Medium (2) — inconsistent demo data undermines tutorials, may require manual cleanup
- **Score:** 4 (Medium)
- **Mitigation:** Make provisioning idempotent via unique constraints and upserts, add clean-up routine for failed bootstrap attempts, capture metrics on duplicate seeds
- **Residual Risk:** Low once idempotency is implemented; track duplicate strategy counts
- **Detection / Monitoring:** Datadog query watching duplicate `StrategyVersion` rows per user, DB constraint violation alerts

### OPS-001 – Audit trail emissions not monitored for drop/misconfiguration
- **Category:** Operational
- **Description:** Audit log forwarding to Datadog & ComplianceEvent log relies on infrastructure wiring; missing monitors could let silent failures go unnoticed.
- **Affected Components:** Supabase webhook pipeline, Datadog ingestion, ComplianceEvent model, CI/CD secrets
- **Probability:** Medium (2) — infra drift or credential expiration is plausible
- **Impact:** Medium (2) — loss of audit data hurts incident response and compliance posture
- **Score:** 4 (Medium)
- **Mitigation:** Add dashboards/alerts for auth audit volumes, include audit pipeline verification in release checklist, run periodic backfill jobs validating ingestion completeness
- **Residual Risk:** Medium; depends on ongoing observability discipline
- **Detection / Monitoring:** Datadog alert on zero audit events over rolling window, Supabase function error logs

### SEC-002 – Cookie/session hardening regressions (Secure/SameSite/rotation)
- **Category:** Security
- **Description:** HttpOnly cookie configuration must stay aligned with security guidelines. Misconfiguration during iterative auth changes could downgrade protection.
- **Affected Components:** `apps/web/src/lib/supabase/server.ts`, middleware cookie helpers, environment config
- **Probability:** Low (1) — current implementation correct, but regressions possible during refactors
- **Impact:** High (3) — weakened cookies expose session hijack risk
- **Score:** 3 (Low)
- **Mitigation:** Add unit test asserting cookie flags, include lint rule or static check for Secure/SameSite settings, document rotation policy
- **Residual Risk:** Low with automated guardrails
- **Detection / Monitoring:** Security scan verifying cookie attributes in staging and prod, periodic penetration testing

## Risk-Based Testing Strategy
- **Priority 1 (High Risk – must cover pre-ship):**
  - Playwright OAuth consent flow covering happy path, missing-consent, and consent revocation
  - API integration test verifying FastAPI rejects bootstrap when consent absent and accepts when metadata flag present
- **Priority 2 (Medium Risks):**
  - Contract tests for shared auth token validator across Next.js/FastAPI
  - Database test ensuring workspace provisioning is idempotent with retries
  - Smoke test verifying audit events reach Datadog & ComplianceEvent logs end-to-end
- **Priority 3 (Low Risk):**
  - Unit test around cookie helper enforcing Secure/SameSite/HttpOnly flags

## Development Focus Recommendations
- Centralize auth contract in shared library, enforce version bumps when changed
- Implement idempotent seeding with explicit conflict handling and observability hooks
- Institutionalize audit pipeline monitors and add release checklist items for consent regression testing

## Deployment & Rollout Guidance
- Use feature flag or staged rollout for new onboarding flows so audit/consent metrics can be observed before full exposure
- Maintain rollback plan disabling workspace bootstrap or falling back to minimal onboarding if consent flow regresses

## Monitoring Requirements
- Dashboard tracking: OAuth consent success rate, FastAPI 403 counts, duplicate strategy rows, audit event throughput
- Alerts: Consent failure spike, zero audit events in 1h, bootstrap latency > threshold

## Risk Acceptance
- No critical (score ≥ 9) risks identified
- High-risk SEC-001 requires mitigation before production sign-off or formal acceptance by compliance lead
- Medium and low risks acceptable with documented mitigations and monitoring commitments

---
Risk profile: docs/qa/assessments/1.1-risk-20250927.md
