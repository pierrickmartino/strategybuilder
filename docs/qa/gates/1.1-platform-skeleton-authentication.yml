schema: 1
story: '1.1'
story_title: 'Platform Skeleton & Authentication'
gate: FAIL
status_reason: 'Middleware leaves the workspace route unprotected and OAuth consent is never recorded, so bootstrap fails for OAuth users.'
reviewer: 'Quinn (Test Architect)'
updated: '2025-09-26T19:57:33Z'
quality_score: 60
top_issues:
  - id: QA-1
    title: 'Protected route middleware misses base workspace path'
    severity: high
    status: open
    description: 'Regex requires a trailing slash, letting unauthenticated users load `/[locale]/strategies` and bypassing the consent guard.'
    refs:
      - apps/web/src/middleware.ts:5
    suggested_owner: dev
  - id: QA-2
    title: 'OAuth sign-ins skip consent enforcement'
    severity: high
    status: open
    description: 'OAuth flow never captures simulation-only consent, so the API returns 403 and the workspace bootstrap never succeeds for those users.'
    refs:
      - apps/web/src/app/(auth)/[locale]/login/auth-form.tsx:37
      - apps/api/app/auth/dependencies.py:69
    suggested_owner: dev
waiver:
  active: false
evidence:
  tests_reviewed: 3
  risks_identified: 2
  trace:
    ac_covered: [1, 3, 4]
    ac_gaps: [2]
nfr_validation:
  security:
    status: FAIL
    notes: 'Protected route bypass and missing OAuth consent handling are blocking security issues.'
  performance:
    status: PASS
    notes: 'Bootstrap call is cached and no perf regressions observed.'
  reliability:
    status: CONCERNS
    notes: 'Workspace bootstrap fails for OAuth sign-ins and there is no graceful recovery path.'
  maintainability:
    status: CONCERNS
    notes: 'Key auth paths lack automated coverage; only a store unit test was added.'
recommendations:
  immediate:
    - action: 'Fix middleware regex to protect `/[locale]/strategies` for unauthenticated users.'
      refs:
        - apps/web/src/middleware.ts
      suggested_owner: dev
    - action: 'Persist consent for OAuth sign-ins and surface clear messaging/retry when consent is missing.'
      refs:
        - apps/web/src/app/(auth)/[locale]/login/auth-form.tsx
        - apps/web/src/hooks/use-workspace-bootstrap.ts
      suggested_owner: dev
  future:
    - action: 'Automate frontend integration tests for auth, consent, and workspace bootstrap flows.'
      refs:
        - apps/web/tests
      suggested_owner: dev
    - action: 'Add API tests covering consent-required 403 scenarios.'
      refs:
        - apps/api/tests/test_workspace_bootstrap.py
        - apps/api/app/auth/dependencies.py
      suggested_owner: dev
expires: '2025-10-10T00:00:00Z'
