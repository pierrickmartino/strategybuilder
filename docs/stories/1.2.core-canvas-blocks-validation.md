# Story 1.2: Core Canvas Blocks & Validation

## Status
Approved

## Story
**As a** strategy tinkerer,
**I want** to drag blocks onto a canvas and connect them with real-time validation,
**so that** I can assemble a working strategy without writing code.

## Acceptance Criteria
1. Canvas supports drag-and-drop, block linking, and deletion with undo, using at least five starter block types.
2. Inline validation flags missing inputs, incompatible block connections, and quota breaches.
3. Block configuration side panel exposes editable parameters with hint text and default ranges.
4. Strategy versions auto-save with timestamped history and ability to revert to previous version.

## Tasks / Subtasks
- [ ] Implement drag-and-drop canvas interactions and block lifecycle (AC: 1)
  - [ ] Extend `StrategyCanvas` and related components under the documented component tree to support drag, link, delete, and undo behaviors. (AC: 1) [Source: architecture/frontend-architecture.md#component-architecture]
  - [ ] Update the `useStrategyCanvas` store to track node/edge mutations, maintain an undo stack, and persist graphs per the state management guidelines. (AC: 1) [Source: architecture/frontend-architecture.md#state-management-architecture]
  - [ ] Define starter block metadata and shared contracts in `packages/shared` so UI and API consume consistent block schemas. (AC: 1) [Source: architecture/coding-standards.md#critical-fullstack-rules]
- [ ] Deliver inline validation with real-time feedback (AC: 2)
  - [ ] Wire Zustand listeners to trigger validation events and surface inline badges immediately when graph issues occur. (AC: 2) [Source: architecture/frontend-architecture.md#state-management-patterns]
  - [ ] Implement or extend FastAPI graph validation using the documented input validation pipeline to detect missing inputs, incompatible links, and quota breaches. (AC: 2) [Source: architecture/security-and-performance.md#security-requirements]
  - [ ] Map validation responses into UI errors using the shared error interpretation helpers. (AC: 2) [Source: architecture/error-handling-strategy.md#frontend-error-handling]
- [ ] Build configurable block side panel with guidance (AC: 3)
  - [ ] Add configuration panel components within `apps/web/src/components/canvas` that follow the component architecture and responsive drawer behavior. (AC: 3) [Source: architecture/frontend-architecture.md#component-architecture]
  - [ ] Persist parameter edits in the canvas store while syncing server-backed defaults through React Query selectors. (AC: 3) [Source: architecture/frontend-architecture.md#state-management-patterns]
  - [ ] Surface hint text, ranges, and accessibility affordances through design system primitives respecting the accessibility strategy. (AC: 3) [Source: architecture/frontend-architecture.md#responsive-accessibility-strategy]
- [ ] Auto-save strategy versions with revert capability (AC: 4)
  - [ ] Invoke `POST /strategies/{strategyId}/versions` when significant graph updates occur to persist snapshots in Supabase. (AC: 4) [Source: architecture/api-specification.md#api-specification]
  - [ ] Ensure persisted records align with `StrategyVersion` schema for graph JSON, versioning, and audit timestamps. (AC: 4) [Source: architecture/data-models.md#strategyversion]
  - [ ] Expose version history and revert controls in the dashboard route while coordinating with canvas hydration. (AC: 4) [Source: architecture/frontend-architecture.md#routing-architecture]
- [ ] Add automated validation coverage (AC: 1,2,3,4)
  - [ ] Write frontend unit and integration tests covering drag/drop flows, validation badges, and configuration panels in the prescribed directories. (AC: 1,2,3) [Source: architecture/testing-strategy.md#frontend]
  - [ ] Extend backend unit and integration suites for the graph validator and version persistence logic. (AC: 2,4) [Source: architecture/testing-strategy.md#backend]
  - [ ] Update Playwright E2E scenarios to exercise block editing, inline validation errors, and version rollback success. (AC: 1,2,4) [Source: architecture/testing-strategy.md#e2e]

## Dev Notes
### Previous Story Insights
- Canvas hydration already uses the shared Zustand store pattern; continue building on that state management approach for new block behaviors. [Source: architecture/frontend-architecture.md#state-management-architecture]

### Data Models
- Manage block graph snapshots through `StrategyVersion` records with `graph_json`, `version`, and `created_at` fields to track history. [Source: architecture/data-models.md#strategyversion]
- Maintain associations with parent `Strategy` entities so owner metadata and visibility propagate to new versions. [Source: architecture/data-models.md#strategy]

### API Specifications
- Use the documented `/strategies/{strategyId}/versions` endpoint to persist canvas updates via FastAPI. [Source: architecture/api-specification.md#api-specification]
- Keep REST handlers under `apps/api/src/api/routers` and delegate persistence to dedicated services per controller template guidance. [Source: architecture/backend-architecture.md#controller-template]

### Component Specifications
- `StrategyCanvas` lives within the Next.js experience layer; enhancements must follow the component organization and layering described for canvas modules. [Source: architecture/frontend-architecture.md#component-architecture]
- Apply the frontend services layer and API client hooks to fetch/save strategy data while respecting authenticated sessions. [Source: architecture/frontend-architecture.md#frontend-services-layer]
- Ensure UI state integrates with React Query + Zustand separation so validation requests donâ€™t thrash server caches. [Source: architecture/frontend-architecture.md#state-management-patterns]

### File Locations
- Place canvas UI updates inside `apps/web/src/components/canvas` and related hooks/stores under `apps/web/src/stores`. [Source: architecture/frontend-architecture.md#component-architecture]
- Backend validation and version routes belong in `apps/api/src/api/routers/strategy_versions.py` (or similar) with services under `apps/api/src/services`. [Source: architecture/backend-architecture.md#controllerroute-organization]
- Shared block and version types must reside in `packages/shared` to keep contracts consistent. [Source: architecture/coding-standards.md#critical-fullstack-rules]

### Project Structure Notes
- No structural conflicts identified; continue adhering to the unified monorepo layout for apps, packages, and shared docs. [Source: architecture/unified-project-structure.md#unified-project-structure]

### Testing Requirements
- Frontend tests should live in `apps/web/tests/unit` and `apps/web/tests/integration` with utilities in `apps/web/tests/utils`. [Source: architecture/testing-strategy.md#frontend]
- Backend tests belong in `apps/api/tests/unit` and `apps/api/tests/integration` with fixtures managed per documented structure. [Source: architecture/testing-strategy.md#backend]
- E2E flows run from `tests/e2e`, extending the onboarding/backtest scenarios to cover canvas validation. [Source: architecture/testing-strategy.md#e2e]

### Technical Constraints
- Continue using the documented Next.js/React Query/Zustand frontend stack and FastAPI/SQLAlchemy backend stack. [Source: architecture/tech-stack.md#tech-stack]
- Enforce async patterns and shared contract rules when adding validators or services. [Source: architecture/coding-standards.md#critical-fullstack-rules]
- Apply security requirements for input validation and session handling during canvas saves and validations. [Source: architecture/security-and-performance.md#security-requirements]
- Interpret API errors with the shared helper so validation feedback surfaces consistently. [Source: architecture/error-handling-strategy.md#frontend-error-handling]

### Testing
- Use `pnpm turbo run test` for frontend suites and `poetry run pytest apps/api` for backend coverage to mirror CI. [Source: architecture/development-workflow.md#development-commands]
- Execute relevant Playwright specs under `tests/e2e` to verify validation and rollback flows. [Source: architecture/testing-strategy.md#e2e]

## Change Log
| Date | Version | Description | Author |
| --- | --- | --- | --- |
| 2025-09-27 | v0.1 | Initial draft created. | Scrum Master |

## Dev Agent Record
### Agent Model Used

- _TBD_

### Debug Log References

- _TBD_

### Completion Notes List

- _TBD_

### File List

- _TBD_

## QA Results
- Risk profile filed: docs/qa/assessments/1.2-risk-20250927.md (CONCERNS - address TECH-002 and DATA-002 before sign-off).
