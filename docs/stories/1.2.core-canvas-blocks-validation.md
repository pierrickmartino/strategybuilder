# Story 1.2: Core Canvas Blocks & Validation

## Status
Ready for Review

## Story
**As a** strategy tinkerer,
**I want** to drag blocks onto a canvas and connect them with real-time validation,
**so that** I can assemble a working strategy without writing code.

## Acceptance Criteria
1. Canvas supports drag-and-drop, block linking, and deletion with undo, using at least five starter block types.
2. Inline validation flags missing inputs, incompatible block connections, and quota breaches.
3. Block configuration side panel exposes editable parameters with hint text and default ranges.
4. Strategy versions auto-save with timestamped history and ability to revert to previous version.

## Tasks / Subtasks
- [x] Implement drag-and-drop canvas interactions and block lifecycle (AC: 1)
  - [x] Extend `StrategyCanvas` and related components under the documented component tree to support drag, link, delete, and undo behaviors. (AC: 1) [Source: architecture/frontend-architecture.md#component-architecture]
  - [x] Update the `useStrategyCanvas` store to track node/edge mutations, maintain an undo stack, and persist graphs per the state management guidelines. (AC: 1) [Source: architecture/frontend-architecture.md#state-management-architecture]
  - [x] Define starter block metadata and shared contracts in `packages/shared` so UI and API consume consistent block schemas. (AC: 1) [Source: architecture/coding-standards.md#critical-fullstack-rules]
- [x] Deliver inline validation with real-time feedback (AC: 2)
  - [x] Wire Zustand listeners to trigger validation events and surface inline badges immediately when graph issues occur. (AC: 2) [Source: architecture/frontend-architecture.md#state-management-patterns]
  - [x] Implement or extend FastAPI graph validation using the documented input validation pipeline to detect missing inputs, incompatible links, and quota breaches. (AC: 2) [Source: architecture/security-and-performance.md#security-requirements]
  - [x] Map validation responses into UI errors using the shared error interpretation helpers. (AC: 2) [Source: architecture/error-handling-strategy.md#frontend-error-handling]
- [x] Build configurable block side panel with guidance (AC: 3)
  - [x] Add configuration panel components within `apps/web/src/components/canvas` that follow the component architecture and responsive drawer behavior. (AC: 3) [Source: architecture/frontend-architecture.md#component-architecture]
  - [x] Persist parameter edits in the canvas store while syncing server-backed defaults through React Query selectors. (AC: 3) [Source: architecture/frontend-architecture.md#state-management-patterns]
  - [x] Surface hint text, ranges, and accessibility affordances through design system primitives respecting the accessibility strategy. (AC: 3) [Source: architecture/frontend-architecture.md#responsive-accessibility-strategy]
- [x] Auto-save strategy versions with revert capability (AC: 4)
  - [x] Invoke `POST /strategies/{strategyId}/versions` when significant graph updates occur to persist snapshots in Supabase. (AC: 4) [Source: architecture/api-specification.md#api-specification]
  - [x] Ensure persisted records align with `StrategyVersion` schema for graph JSON, versioning, and audit timestamps. (AC: 4) [Source: architecture/data-models.md#strategyversion]
  - [x] Expose version history and revert controls in the dashboard route while coordinating with canvas hydration. (AC: 4) [Source: architecture/frontend-architecture.md#routing-architecture]
- [x] Add automated validation coverage (AC: 1,2,3,4)
  - [x] Write frontend unit and integration tests covering drag/drop flows, validation badges, and configuration panels in the prescribed directories. (AC: 1,2,3) [Source: architecture/testing-strategy.md#frontend]
  - [x] Extend backend unit and integration suites for the graph validator and version persistence logic. (AC: 2,4) [Source: architecture/testing-strategy.md#backend]
  - [x] Update Playwright E2E scenarios to exercise block editing, inline validation errors, and version rollback success. (AC: 1,2,4) [Source: architecture/testing-strategy.md#e2e]

## Dev Notes
### Previous Story Insights
- Canvas hydration already uses the shared Zustand store pattern; continue building on that state management approach for new block behaviors. [Source: architecture/frontend-architecture.md#state-management-architecture]

### Data Models
- Manage block graph snapshots through `StrategyVersion` records with `graph_json`, `version`, and `created_at` fields to track history. [Source: architecture/data-models.md#strategyversion]
- Maintain associations with parent `Strategy` entities so owner metadata and visibility propagate to new versions. [Source: architecture/data-models.md#strategy]

### API Specifications
- Use the documented `/strategies/{strategyId}/versions` endpoint to persist canvas updates via FastAPI. [Source: architecture/api-specification.md#api-specification]
- Keep REST handlers under `apps/api/src/api/routers` and delegate persistence to dedicated services per controller template guidance. [Source: architecture/backend-architecture.md#controller-template]

### Component Specifications
- `StrategyCanvas` lives within the Next.js experience layer; enhancements must follow the component organization and layering described for canvas modules. [Source: architecture/frontend-architecture.md#component-architecture]
- Apply the frontend services layer and API client hooks to fetch/save strategy data while respecting authenticated sessions. [Source: architecture/frontend-architecture.md#frontend-services-layer]
- Ensure UI state integrates with React Query + Zustand separation so validation requests don’t thrash server caches. [Source: architecture/frontend-architecture.md#state-management-patterns]

### File Locations
- Place canvas UI updates inside `apps/web/src/components/canvas` and related hooks/stores under `apps/web/src/stores`. [Source: architecture/frontend-architecture.md#component-architecture]
- Backend validation and version routes belong in `apps/api/src/api/routers/strategy_versions.py` (or similar) with services under `apps/api/src/services`. [Source: architecture/backend-architecture.md#controllerroute-organization]
- Shared block and version types must reside in `packages/shared` to keep contracts consistent. [Source: architecture/coding-standards.md#critical-fullstack-rules]

### Project Structure Notes
- No structural conflicts identified; continue adhering to the unified monorepo layout for apps, packages, and shared docs. [Source: architecture/unified-project-structure.md#unified-project-structure]

### Testing Requirements
- Frontend tests should live in `apps/web/tests/unit` and `apps/web/tests/integration` with utilities in `apps/web/tests/utils`. [Source: architecture/testing-strategy.md#frontend]
- Backend tests belong in `apps/api/tests/unit` and `apps/api/tests/integration` with fixtures managed per documented structure. [Source: architecture/testing-strategy.md#backend]
- E2E flows run from `tests/e2e`, extending the onboarding/backtest scenarios to cover canvas validation. [Source: architecture/testing-strategy.md#e2e]

### Technical Constraints
- Continue using the documented Next.js/React Query/Zustand frontend stack and FastAPI/SQLAlchemy backend stack. [Source: architecture/tech-stack.md#tech-stack]
- Enforce async patterns and shared contract rules when adding validators or services. [Source: architecture/coding-standards.md#critical-fullstack-rules]
- Apply security requirements for input validation and session handling during canvas saves and validations. [Source: architecture/security-and-performance.md#security-requirements]
- Interpret API errors with the shared helper so validation feedback surfaces consistently. [Source: architecture/error-handling-strategy.md#frontend-error-handling]

### Testing
- Use `pnpm turbo run test` for frontend suites and `poetry run pytest apps/api` for backend coverage to mirror CI. [Source: architecture/development-workflow.md#development-commands]
- Execute relevant Playwright specs under `tests/e2e` to verify validation and rollback flows. [Source: architecture/testing-strategy.md#e2e]

## Change Log
| Date | Version | Description | Author |
| --- | --- | --- | --- |
| 2025-09-27 | v0.1 | Initial draft created. | Scrum Master |
| 2025-09-28 | v0.2 | Surfaced global validation blockers and added revert confirmation per QA feedback. | James |
| 2025-09-29 | v0.3 | Added undo/redo controls, safe ID helper, and new regression coverage per QA findings. | James |

## Dev Agent Record
### Agent Model Used

- Codex (GPT-5)

### Debug Log References

- `pnpm --filter @strategybuilder/web test`

### Completion Notes List

- Added undo/redo toolbar actions and keyboard shortcuts wired to the canvas history stack for user-facing recovery.
- Replaced direct `crypto.randomUUID` usages with a shared ID helper to support Safari/WebView clients and updated workspace seeding.
- Extended integration coverage for undo UX, keyboard shortcuts, and ID fallback to close the QA regression gaps.

### File List

- apps/web/src/app/(dashboard)/[locale]/strategies/strategies-workspace.tsx
- apps/web/src/components/canvas/StrategyCanvas.tsx
- apps/web/tests/integration/StrategyCanvas.test.tsx
- packages/shared/src/id.ts
- packages/shared/src/index.ts

## QA Results
- Risk profile filed: docs/qa/assessments/1.2-risk-20250927.md (CONCERNS - address TECH-002 and DATA-002 before sign-off).
- Test design matrix filed: docs/qa/assessments/1.2-test-design-20250927.md (P0 coverage: 9 scenarios across UNIT/INT/E2E).

### Review Date: 2025-09-28

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment
Frontend and backend share the catalog correctly, but the canvas drops plan quota and other non-node issues so users never see them, leaving validation feedback incomplete; revert workflow otherwise behaves, yet automated coverage highlights an expectation mismatch.

### Refactoring Performed
- None.

### Compliance Check
- Coding Standards: PASS – implementation follows shared contracts and coding guidance.
- Project Structure: PASS – files land in the documented locations.
- Testing Strategy: FAIL – Playwright spec asserts a "Restored" toast that the UI never renders, so the suite fails.
- All ACs Met: FAIL – AC2 (quota breach visibility) remains unmet.

### Improvements Checklist
- [ ] Surface validation issues without node identifiers (quota, dangling edges) in the canvas UI so users can act on them.
- [ ] Align the Playwright expectation with the actual revert UX and add explicit success feedback if desired.

### Security Review
No new security concerns; validation remains auth-scoped and read-only.

### Performance Considerations
No performance regressions observed; validation and autosave stay within expected bounds.

### Files Modified During Review
- None.

### Gate Status
Gate: FAIL → docs/qa/gates/1.2-core-canvas-blocks-validation.yml
Validation issues without node context remain hidden, so quota and dangling edge errors still violate AC2. Playwright revert coverage continues to fail awaiting visible success feedback.
Risk profile: docs/qa/assessments/1.2-risk-20250927.md
NFR assessment: docs/qa/assessments/1.2-nfr-20250927.md

### Recommended Status
✗ Changes Required – See unchecked items above

### Review Date: 2025-09-28 (Follow-up)

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment
Undo support is still missing from the user-facing experience, so deletions cannot be reversed despite the store maintaining history. Block creation also relies on `crypto.randomUUID`, which throws on older Safari/WebView stacks we continue to support. The remaining canvas flows behave as expected, but these gaps block sign-off.

### Refactoring Performed
- None.

### Compliance Check
- Coding Standards: ✓ – Implementation continues to follow shared contracts and styling conventions.
- Project Structure: ✓ – Files remain in the documented canvas and store locations.
- Testing Strategy: ✗ – No automated coverage exercises undo/redo interactions or the Safari ID generation fallback, leaving regressions undetected.
- All ACs Met: ✗ – AC1 fails because undo is not exposed to end users.

### Improvements Checklist
- [ ] Expose undo/redo controls (toolbar + keyboard shortcuts) wired to `useStrategyCanvas().undo/redo` so AC1 is fulfilled (`apps/web/src/components/canvas/StrategyCanvas.tsx`).
- [ ] Cover undo flows with integration/E2E tests and add a compatibility test for block ID generation on unsupported browsers.
- [ ] Replace `crypto.randomUUID` with a cross-browser UUID helper or guarded fallback to prevent drag/drop failures.

### Security Review
No new security issues discovered during re-review.

### Performance Considerations
Persisted history remains efficient, but the missing undo UI means users may attempt repeated deletions, increasing autosave churn—addressing undo mitigates this.

### Files Modified During Review
- None.

### Gate Status
Gate: FAIL → docs/qa/gates/1.2-core-canvas-blocks-validation.yml
Risk profile: docs/qa/assessments/1.2-risk-20250927.md
NFR assessment: docs/qa/assessments/1.2-nfr-20250927.md

### Recommended Status
✗ Changes Required – Undo functionality and compatibility fixes remain outstanding
